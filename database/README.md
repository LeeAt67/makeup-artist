# æ•°æ®åº“ SQL è„šæœ¬è¯´æ˜

æœ¬ç›®å½•åŒ…å«æ‰€æœ‰ Supabase æ•°æ®åº“çš„ SQL è„šæœ¬ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ‰§è¡Œè„šæœ¬ä»¥æ­£ç¡®è®¾ç½®æ•°æ®åº“ã€‚

## ğŸ“‹ æ‰§è¡Œé¡ºåº

### ç¬¬ä¸€æ­¥ï¼šåŸºç¡€è®¾ç½®

#### 1. `supabase-setup.sql` - åŸºç¡€è¡¨ç»“æ„ â­ å¿…é¡»å…ˆæ‰§è¡Œ

åˆ›å»ºä»¥ä¸‹åŸºç¡€è¡¨ï¼š

- `profiles` - ç”¨æˆ·èµ„æ–™è¡¨
- `makeups` - æ—§ç‰ˆå¦†å®¹è¡¨ï¼ˆå·²å¼ƒç”¨ï¼‰
- `favorites` - æ”¶è—è¡¨
- `face_scans` - è„¸å‹è¯†åˆ«è®°å½•è¡¨

**æ‰§è¡Œæ—¶æœº**ï¼šé¡¹ç›®åˆå§‹åŒ–æ—¶ç¬¬ä¸€ä¸ªæ‰§è¡Œ

---

### ç¬¬äºŒæ­¥ï¼šæ ¸å¿ƒåŠŸèƒ½è¡¨

#### 2. `supabase-makeup-posts.sql` - å¦†å®¹å¸–å­ç³»ç»Ÿ â­ æ ¸å¿ƒåŠŸèƒ½

åˆ›å»ºä»¥ä¸‹è¡¨ï¼š

- `makeup_posts` - å¦†å®¹å¸–å­è¡¨ï¼ˆä¸»è¡¨ï¼‰
- `makeup_likes` - å¸–å­ç‚¹èµè¡¨
- `makeup_favorites` - å¸–å­æ”¶è—è¡¨

**åŠŸèƒ½**ï¼šæ”¯æŒå¦†å®¹å†…å®¹çš„å‘å¸ƒã€ç‚¹èµã€æ”¶è—

**æ‰§è¡Œæ—¶æœº**ï¼šåœ¨ `supabase-setup.sql` ä¹‹åæ‰§è¡Œ

---

#### 3. `supabase-comments-system.sql` - è¯„è®ºç³»ç»Ÿ â­ æ ¸å¿ƒåŠŸèƒ½

åˆ›å»ºä»¥ä¸‹è¡¨ï¼š

- `makeup_comments` - è¯„è®ºè¡¨ï¼ˆæ”¯æŒåµŒå¥—è¯„è®ºï¼‰
- `comment_likes` - è¯„è®ºç‚¹èµè¡¨

**åŠŸèƒ½**ï¼šæ”¯æŒè¯„è®ºã€å›å¤ã€ç‚¹èµè¯„è®º

**æ³¨æ„**ï¼šæ­¤è„šæœ¬å·²ä¿®å¤å¤–é”®å…³ç³»é—®é¢˜ï¼Œ`user_id` å¼•ç”¨ `public.profiles`

**æ‰§è¡Œæ—¶æœº**ï¼šåœ¨ `supabase-makeup-posts.sql` ä¹‹åæ‰§è¡Œ

---

#### 4. `supabase-products-system.sql` - äº§å“ç³»ç»Ÿ â­ æ ¸å¿ƒåŠŸèƒ½

åˆ›å»ºä»¥ä¸‹è¡¨ï¼š

- `products` - äº§å“è¡¨
- `product_reviews` - äº§å“è¯„ä»·è¡¨
- `makeup_products` - å¦†å®¹äº§å“å…³è”è¡¨

**åŠŸèƒ½**ï¼šæ”¯æŒç¾å¦†äº§å“å±•ç¤ºã€è¯„ä»·ã€ä¸å¦†å®¹å…³è”

**æ‰§è¡Œæ—¶æœº**ï¼šåœ¨ `supabase-makeup-posts.sql` ä¹‹åæ‰§è¡Œ

---

#### 5. `supabase-rpc-functions.sql` - RPC å‡½æ•°

åˆ›å»ºæ•°æ®åº“å‡½æ•°ï¼š

- `increment_view_count()` - å¢åŠ æµè§ˆæ•°ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
- å…¶ä»–è¾…åŠ©å‡½æ•°

**åŠŸèƒ½**ï¼šæä¾›æ•°æ®åº“çº§åˆ«çš„åŠŸèƒ½å‡½æ•°

**æ‰§è¡Œæ—¶æœº**ï¼šåœ¨æ‰€æœ‰è¡¨åˆ›å»ºå®Œæˆåæ‰§è¡Œ

---

### ç¬¬ä¸‰æ­¥ï¼šæ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰

#### 6. `supabase-migration-phone.sql` - æ‰‹æœºå·è®¤è¯è¿ç§»

æ·»åŠ æ‰‹æœºå·è®¤è¯ç›¸å…³å­—æ®µå’ŒåŠŸèƒ½

**æ‰§è¡Œæ—¶æœº**ï¼šä»…åœ¨éœ€è¦æ‰‹æœºå·è®¤è¯æ—¶æ‰§è¡Œ

---

#### 7. `supabase-migration-profile-update.sql` - ç”¨æˆ·èµ„æ–™å­—æ®µæ›´æ–°

æ›´æ–°ç”¨æˆ·èµ„æ–™è¡¨å­—æ®µï¼ˆå¦‚æ·»åŠ  `bio` å­—æ®µï¼‰

**æ‰§è¡Œæ—¶æœº**ï¼šåœ¨ `supabase-setup.sql` ä¹‹åï¼Œéœ€è¦æ‰©å±•ç”¨æˆ·èµ„æ–™åŠŸèƒ½æ—¶æ‰§è¡Œ

---

### ç¬¬å››æ­¥ï¼šç¤ºä¾‹æ•°æ®ï¼ˆå¼€å‘æµ‹è¯•ï¼‰

#### 8. `supabase-insert-sample-data.sql` - ç¤ºä¾‹æ•°æ®ï¼ˆæ‰‹åŠ¨ç‰ˆï¼‰

æ’å…¥æµ‹è¯•æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š

- ç¤ºä¾‹å¦†å®¹å¸–å­
- ç¤ºä¾‹äº§å“
- ç¤ºä¾‹è¯„è®º

**æ³¨æ„**ï¼šéœ€è¦æ‰‹åŠ¨æ›¿æ¢è„šæœ¬ä¸­çš„ç”¨æˆ· UUID

**æ‰§è¡Œæ—¶æœº**ï¼šå¼€å‘æµ‹è¯•æ—¶æ‰§è¡Œï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦æ‰§è¡Œ

---

#### 9. `supabase-insert-sample-data-auto.sql` - ç¤ºä¾‹æ•°æ®ï¼ˆè‡ªåŠ¨ç‰ˆï¼‰

è‡ªåŠ¨æ’å…¥æµ‹è¯•æ•°æ®ï¼ˆæ— éœ€æ‰‹åŠ¨ä¿®æ”¹ UUIDï¼‰

**æ‰§è¡Œæ—¶æœº**ï¼šå¼€å‘æµ‹è¯•æ—¶æ‰§è¡Œï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦æ‰§è¡Œ

---

## ğŸ”§ ä¿®å¤è„šæœ¬ï¼ˆæ•…éšœæ’æŸ¥ï¼‰

### `supabase-fix-makeup-posts-fk.sql` - ä¿®å¤å¦†å®¹è¡¨å¤–é”®

**é—®é¢˜**ï¼š`makeup_posts` è¡¨å¤–é”®å…³ç³»é”™è¯¯

**ç—‡çŠ¶**ï¼šæŸ¥è¯¢å¦†å®¹æ—¶å‡ºç°å¤–é”®å…³ç³»æ‰¾ä¸åˆ°çš„é”™è¯¯

**è§£å†³**ï¼šåˆ é™¤å¹¶é‡æ–°åˆ›å»º `makeup_posts` ç›¸å…³è¡¨

**âš ï¸ è­¦å‘Š**ï¼šä¼šåˆ é™¤æ‰€æœ‰å¦†å®¹æ•°æ®

**æ‰§è¡Œæ—¶æœº**ï¼šä»…åœ¨é‡åˆ°ç›¸å…³é”™è¯¯æ—¶æ‰§è¡Œ

---

### `supabase-fix-comments-fk.sql` - ä¿®å¤è¯„è®ºè¡¨å¤–é”®

**é—®é¢˜**ï¼š`makeup_comments` è¡¨çš„ `user_id` å¼•ç”¨ `auth.users` å¯¼è‡´å…³ç³»è¯†åˆ«å¤±è´¥

**ç—‡çŠ¶**ï¼šåˆ›å»ºè¯„è®ºæ—¶æç¤º "Could not find a relationship between 'makeup_comments' and 'user_id'"

**è§£å†³**ï¼šåˆ é™¤å¹¶é‡æ–°åˆ›å»ºè¯„è®ºè¡¨ï¼Œä½¿ç”¨æ­£ç¡®çš„å¤–é”®å¼•ç”¨ï¼ˆ`public.profiles`ï¼‰

**âš ï¸ è­¦å‘Š**ï¼šä¼šåˆ é™¤æ‰€æœ‰è¯„è®ºæ•°æ®

**æ‰§è¡Œæ—¶æœº**ï¼šä»…åœ¨é‡åˆ°ç›¸å…³é”™è¯¯æ—¶æ‰§è¡Œ

---

## ğŸš€ å®Œæ•´åˆå§‹åŒ–æµç¨‹

### æ–°é¡¹ç›®åˆå§‹åŒ–

```bash
# 1. åŸºç¡€è¡¨
æ‰§è¡Œ: supabase-setup.sql

# 2. æ ¸å¿ƒåŠŸèƒ½è¡¨
æ‰§è¡Œ: supabase-makeup-posts.sql
æ‰§è¡Œ: supabase-comments-system.sql
æ‰§è¡Œ: supabase-products-system.sql

# 3. RPC å‡½æ•°
æ‰§è¡Œ: supabase-rpc-functions.sql

# 4. ç¤ºä¾‹æ•°æ®ï¼ˆå¯é€‰ï¼‰
æ‰§è¡Œ: supabase-insert-sample-data-auto.sql
```

### æ€»æ‰§è¡Œæ—¶é—´

çº¦ 2-5 åˆ†é’Ÿï¼ˆå–å†³äºç½‘ç»œé€Ÿåº¦ï¼‰

---

## ğŸ“ æ‰§è¡Œæ–¹å¼

### åœ¨ Supabase Dashboard ä¸­æ‰§è¡Œ

1. ç™»å½• [Supabase Dashboard](https://supabase.com/dashboard)
2. é€‰æ‹©æ‚¨çš„é¡¹ç›®
3. ç‚¹å‡»å·¦ä¾§èœå•çš„ **SQL Editor**
4. ç‚¹å‡» **New Query**
5. å¤åˆ¶è„šæœ¬å†…å®¹å¹¶ç²˜è´´
6. ç‚¹å‡» **Run** æ‰§è¡Œ
7. æ£€æŸ¥æ‰§è¡Œç»“æœï¼ˆæˆåŠŸ/é”™è¯¯ï¼‰

### ä½¿ç”¨ Supabase CLIï¼ˆé«˜çº§ï¼‰

```bash
# å®‰è£… Supabase CLI
npm install -g supabase

# ç™»å½•
supabase login

# é“¾æ¥åˆ°é¡¹ç›®
supabase link --project-ref your-project-ref

# æ‰§è¡Œè„šæœ¬
supabase db execute --file database/supabase-setup.sql
supabase db execute --file database/supabase-makeup-posts.sql
# ... ä¾æ¬¡æ‰§è¡Œå…¶ä»–è„šæœ¬
```

---

## âœ… éªŒè¯æ•°æ®åº“è®¾ç½®

æ‰§è¡Œå®Œè„šæœ¬åï¼Œè®¿é—®åº”ç”¨çš„æ•°æ®åº“æ£€æŸ¥å·¥å…·ï¼š

```
http://localhost:3000/test-db/check-tables
```

è¯¥é¡µé¢ä¼šæ˜¾ç¤ºï¼š

- âœ… æ‰€æœ‰è¡¨çš„å­˜åœ¨çŠ¶æ€
- âœ… æ¯ä¸ªè¡¨çš„è®°å½•æ•°é‡
- âœ… é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰

---

## ğŸ¯ æ ¸å¿ƒè¡¨ä¾èµ–å…³ç³»

```
auth.users (Supabase å†…ç½®)
    â†“
profiles (ç”¨æˆ·èµ„æ–™)
    â†“
    â”œâ”€â”€ makeup_posts (å¦†å®¹å¸–å­)
    â”‚   â”œâ”€â”€ makeup_likes (ç‚¹èµ)
    â”‚   â”œâ”€â”€ makeup_favorites (æ”¶è—)
    â”‚   â”œâ”€â”€ makeup_comments (è¯„è®º)
    â”‚   â”‚   â””â”€â”€ comment_likes (è¯„è®ºç‚¹èµ)
    â”‚   â””â”€â”€ makeup_products (å…³è”äº§å“)
    â”‚
    â”œâ”€â”€ products (äº§å“)
    â”‚   â”œâ”€â”€ product_reviews (è¯„ä»·)
    â”‚   â””â”€â”€ makeup_products (å…³è”å¦†å®¹)
    â”‚
    â””â”€â”€ face_scans (è„¸å‹è¯†åˆ«)
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. è¡¨å·²å­˜åœ¨é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š`relation "xxx" already exists`

**è§£å†³æ–¹æ³•**ï¼š

- è„šæœ¬ä½¿ç”¨ `CREATE TABLE IF NOT EXISTS`ï¼Œå¯ä»¥å®‰å…¨é‡å¤æ‰§è¡Œ
- å¦‚éœ€å®Œå…¨é‡å»ºï¼Œå…ˆåˆ é™¤è¡¨å†æ‰§è¡Œè„šæœ¬

### 2. å¤–é”®çº¦æŸé”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š`violates foreign key constraint`

**è§£å†³æ–¹æ³•**ï¼š

- æ£€æŸ¥è¡¨çš„æ‰§è¡Œé¡ºåº
- ç¡®ä¿è¢«å¼•ç”¨çš„è¡¨å·²å­˜åœ¨
- ä½¿ç”¨ä¿®å¤è„šæœ¬é‡æ–°åˆ›å»º

### 3. æƒé™é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š`permission denied`

**è§£å†³æ–¹æ³•**ï¼š

- ç¡®ä¿åœ¨ Supabase Dashboard çš„ SQL Editor ä¸­æ‰§è¡Œ
- æ£€æŸ¥é¡¹ç›®æƒé™è®¾ç½®

### 4. è„šæœ¬æ‰§è¡Œéƒ¨åˆ†æˆåŠŸ

**è§£å†³æ–¹æ³•**ï¼š

- æŸ¥çœ‹é”™è¯¯æç¤ºï¼Œæ‰¾åˆ°å¤±è´¥çš„è¯­å¥
- å•ç‹¬æ‰§è¡Œå¤±è´¥çš„éƒ¨åˆ†
- æˆ–ä½¿ç”¨ä¿®å¤è„šæœ¬é‡æ–°åˆ›å»º

---

## ğŸ“¦ å¤‡ä»½ä¸æ¢å¤

### å¤‡ä»½æ•°æ®

```sql
-- å¯¼å‡ºæ‰€æœ‰æ•°æ®
SELECT * FROM profiles;
SELECT * FROM makeup_posts;
-- ... å¯¼å‡ºå…¶ä»–è¡¨
```

### æ¢å¤æ•°æ®

ä½¿ç”¨ Supabase Dashboard çš„ **Database** â†’ **Backups** åŠŸèƒ½

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Supabase æ–‡æ¡£](https://supabase.com/docs)
- [PostgreSQL æ–‡æ¡£](https://www.postgresql.org/docs/)
- [é¡¹ç›® README](../README.md)
- [æ•°æ®åº“è®¾ç½®æŒ‡å—](../docs/æ•°æ®åº“è®¾ç½®æŒ‡å—.md)
- [API æ–‡æ¡£](../docs/APIæ–‡æ¡£.md)

---

## ğŸ”„ ç‰ˆæœ¬å†å²

### v1.2.0 (2025-10-07)

- âœ… ä¿®å¤è¯„è®ºç³»ç»Ÿå¤–é”®å…³ç³»é—®é¢˜
- âœ… æ·»åŠ äº§å“ç³»ç»Ÿ
- âœ… ä¼˜åŒ–è„šæœ¬æ³¨é‡Šå’Œæ–‡æ¡£

### v1.1.0

- âœ… æ·»åŠ è¯„è®ºç³»ç»Ÿ
- âœ… æ·»åŠ å¦†å®¹å¸–å­ç³»ç»Ÿ

### v1.0.0

- âœ… åˆå§‹ç‰ˆæœ¬
- âœ… åŸºç¡€è¡¨ç»“æ„

---

**æœ€åæ›´æ–°**ï¼š2025-10-07  
**ç»´æŠ¤è€…**ï¼šå¦†å¨˜ APP å¼€å‘å›¢é˜Ÿ
